---
description: "기능 기획 및 API 연동 작업 규칙 및 가이드라인"
globs: ["docs/**/*", "server/**/*.py", "frontend/**/*"]
alwaysApply: false
---

# 기능 기획 및 API 연동 규칙

## 1. 플랫폼 개요 및 목표

### 플랫폼 목적
이 플랫폼은 다양한 오픈 데이터 API(관세청, 한국은행, 인천항만공사, GDELT 등)를 통합하여 단일 사용자 친화적 인터페이스를 제공합니다. 파편화된 API들을 조합하여 사용자 친화적인 통합 대시보드 및 자동화 도구를 제공함으로써 오픈 API 활용도를 높입니다.

### 데이터 소스 범위
- **관세청 (Korea Customs Service)**: 무역 및 물류 데이터 (수출입 통계, 화물량 등)
- **한국은행 (Bank of Korea)**: ECOS API - 경제 지표 (환율, 금리 등)
- **인천항만공사 (Incheon Port Authority)**: 항만 처리량 및 운영 데이터 (컨테이너 물량, 선박 입출항 등)
- **GDELT (Global Events Database)**: 글로벌 뉴스/이벤트 데이터 (맥락적 인사이트 제공)

### 목표 사용자
- 화주, 운송사, 리테일러
- 정책 분석가, 경제 연구원
- 개인 투자자, 비즈니스 분석가

## 2. 기능 기획 방법론

### 작업 전 사전 검증

새로운 기능을 기획하기 전에 다음을 확인:

1. **통합 검증 스크립트 실행**
   ```bash
   python scripts/validate_integration.py
   ```
   - 현재 시스템 상태 파악
   - 기존 기능과의 충돌 여부 확인

2. **API 명세서 확인**
   - `docs/api/` 디렉토리의 개발 명세서 확인
   - 관련 API의 데이터 구조 및 제약사항 파악

3. **기존 기능 분석**
   - 유사한 기능이 이미 존재하는지 확인
   - 기존 UI/UX 패턴 확인
   - 기존 백엔드 API 엔드포인트 확인

4. **의존성 확인**
   - 다른 Agent의 작업이 필요한지 확인
   - 백엔드/프론트엔드 Agent와 협의가 필요한지 확인

### A. API 분석 및 기능 도출 프로세스

1. **API 명세서 사전 학습 필수**
   - API 연동 작업 전에 `docs/api/` 디렉토리의 개발 명세서를 반드시 확인
   - API 엔드포인트 리스트, Request/Response 파라미터, 데이터 필드 설명 분석

2. **데이터 소스별 핵심 메트릭 식별**
   - 각 API가 제공하는 핵심 데이터 포인트 파악
   - 사용자 관점에서 가장 유용한 메트릭 선정
   - 예: 환율 API → 현재 환율, 변동률, 고점/저점, 평균

3. **시각화 방법 결정**
   - 데이터 특성에 맞는 차트 타입 선택
   - Time-Series: 꺾은선 그래프
   - 비교: 막대 그래프, 그룹 차트
   - 구성: 파이 차트, 스택 차트
   - 지리적: 지도 시각화 (필요시)

### B. 기능 기획안 작성 템플릿

#### [Feature Name] 기능 기획안

**1. 개요 (Overview)**
- **기능 정의:** 한 문장으로 기능 설명
- **해결하려는 문제:** 사용자의 불편함 해소
- **비즈니스 가치:** 비용 절감, 시간 단축, 수익 증대, 의사결정 지원

**2. 유저 스토리 (User Story)**
- `As a [유저 역할], I want to [행동], So that [목표/보상]` 형태
- 예: "As a 화주, I want to view monthly export trends, So that I can plan inventory"

**3. 데이터 소스 및 API 매핑**
- **API Source:** 사용할 API 명 및 엔드포인트
- **Key Metrics:** 표시할 핵심 지표 목록
- **Data Mapping:**
  - **Input:** 사용자 입력 → API 파라미터 매핑
  - **Process:** 내부 계산/변환 로직
  - **Output:** API 응답 → UI 표시 데이터 매핑

**4. 시각화 설계 (Visualization Design)**
- **차트 타입:** 꺾은선, 막대, 파이 등
- **X축/Y축:** 각 축의 의미 및 단위
- **다중 시리즈:** 여러 데이터를 동시에 표시하는 방법
- **인터랙티브 요소:** 호버 툴팁, 줌, 범례 토글 등

**5. 사용자 컨트롤 및 필터 (User Controls & Filters)**
- **날짜 범위 선택기:** 기간 선택 방법 (캘린더, 슬라이더, 빠른 선택 버튼)
- **카테고리 필터:** 드롭다운, 멀티셀렉트 등
- **메트릭 토글:** Y축 단위 변경 (예: 금액 vs 물량)
- **뷰 모드:** 그래프 뷰 vs 테이블 뷰

**6. UI/UX 제안 (Wireframe Description)**
- 화면 구성 요소 (차트, 테이블, 필터, 통계 요약)
- 레이아웃 구조
- 반응형 디자인 고려사항
- 기존 디자인 시스템과의 일관성

**7. 개발 시 고려사항 (Tech Notes)**
- **API Rate Limit:** 일일 호출 제한 및 캐싱 전략
- **에러 처리:** API 실패 시 사용자 피드백
- **데이터 품질:** 데이터 부재, 지연 업데이트 처리
- **성능 최적화:** 대용량 데이터 처리, 샘플링 전략
- **보안:** API 키 관리, 입력 검증

## 3. 데이터 소스별 기능 기획 가이드

### A. 무역 통계 대시보드 (관세청)

**핵심 메트릭:**
- 총 수출/수입 금액 (KRW 또는 USD)
- 무역 수지 (수출 - 수입)
- 주요 수출/수입 품목 Top 5-10
- 주요 교역 상대국 Top 5-10
- 물량 지표 (중량, 컨테이너 수 등)

**시각화:**
- Time-Series Line Chart: 시간에 따른 수출/수입 추이
- Bar Chart: 국가별 또는 품목별 비교
- Trade Balance Graph: 무역 수지 추이

**필터:**
- 날짜 범위 (연도, 월 범위)
- 품목 카테고리 (HS 코드 섹션, 성질별 분류)
- 교역 상대국/지역
- 메트릭 토글 (금액 vs 물량)

**특별 고려사항:**
- HS 코드를 사용자 친화적 카테고리로 매핑 (예: "소비재" vs "원자재")
- 연도별 성장률 자동 계산 및 표시
- 평균 운송비용 등 참고 데이터 통합

### B. 환율 및 금융 데이터 (한국은행)

**핵심 메트릭:**
- 주요 통화별 KRW 환율 (USD, EUR, JPY, CNY 등)
- 현재 환율, 변동률, 고점/저점, 평균
- 기준금리, 인플레이션율 (선택적)

**시각화:**
- Time-Series Line Chart: 환율 추이 (다중 통화 오버레이 가능)
- 통계 요약 패널: 현재값, 변동률, 고점/저점/평균

**필터:**
- 통화 선택기 (멀티셀렉트)
- 날짜 범위 선택기
- 빠른 기간 버튼 (1M, 6M, YTD, 5Y, Max)
- 세분화 토글 (일별 vs 월별)

**특별 고려사항:**
- 비교 모드: 여러 통화를 상대적 변화율로 정규화하여 비교
- 툴팁: 정확한 날짜 및 환율 값 표시
- 색맹 친화적 팔레트 사용

### C. 항만 운영 및 물류 데이터 (인천항만공사)

**핵심 메트릭:**
- 컨테이너 처리량 (TEU)
- 화물량 (톤수, 유형별)
- 선박 입출항 통계
- 연도별 성장률 (YoY)

**시각화:**
- Monthly TEU Line/Bar Chart: 월별 컨테이너 처리량
- Annual Throughput Comparison: 연도별 비교 (스택 바 가능)
- Vessel Call Statistics: 선박 입출항 추이

**필터:**
- 연도 선택기
- 메트릭 토글 (TEU vs 선박 수)
- 화물 유형 필터 (컨테이너, 벌크 등)
- 선박 국적 필터 (외국선 vs 국적선)

**특별 고려사항:**
- YoY 성장률 자동 계산 및 표시
- 드릴다운: 연도 클릭 → 해당 연도 월별 상세
- TEU 용어 설명 툴팁 제공

### D. 글로벌 이벤트 및 뉴스 (GDELT)

**핵심 기능:**
- 관련 이벤트 타임라인
- 뉴스 피드/리스트
- 지리적 시각화 (선택적)

**시각화:**
- Interactive Timeline: 시간에 따른 이벤트 밀도
- News Feed: 스크롤 가능한 헤드라인 리스트
- Word Cloud: 주요 테마 시각화 (선택적)

**필터:**
- 키워드/주제 필터 (무역 정책, 자연재해, 경제 지표 등)
- 시간 필터 (다른 섹션과 연동)
- 지역/국가 필터

**특별 고려사항:**
- 상관관계 하이라이트: 차트의 급격한 변화와 관련 이벤트 연결
- 성능: GDELT 데이터는 방대하므로 캐싱 및 사전 필터링 필수
- 출처 표시: 뉴스 헤드라인 및 출처 명시

## 4. 통합 고려사항

### A. 통합 대시보드 레이아웃
- 모든 기능을 일관된 대시보드 인터페이스로 통합
- 탭 또는 섹션 페이지로 구분하되 일관된 헤더/네비게이션 유지
- 섹션 전환 시 매끄러운 사용자 경험

### B. 일관된 UI 요소
- 표준 차트 라이브러리 사용 (Native SVG 권장)
- 통일된 색상 팔레트 및 폰트
- 일관된 인터랙티브 동작 (툴팁, 줌, 범례 토글)

### C. 반응형 디자인
- 모바일: 단일 시리즈 뷰 또는 스와이프 가능한 카드
- 태블릿: 2컬럼 레이아웃
- 데스크톱: 전체 기능 표시

### D. 성능 및 데이터 캐싱
- 백엔드 캐싱: 자주 요청되는 데이터 (일일 환율, 월별 무역 통계)
- 지연 로딩: 이벤트 피드나 무거운 차트는 해당 섹션 뷰 시 로드
- 대용량 데이터: 샘플링 또는 "전체 vs 요약" 옵션 제공
- API 호출 최적화: 배치 요청, 페이지네이션 처리

### E. API 키 및 접근 관리
- 모든 API 키는 서버 측에서 안전하게 관리
- 개발/프로덕션 환경 분리
- 사용량 제한 대응: 서버 측 캐시 또는 프록시로 다중 사용자 요청 재사용

### F. 에러 처리 및 데이터 품질
- 사용자 피드백: 데이터 로드 실패 시 명확한 메시지
- 캐시 데이터 표시: API 실패 시 마지막 캐시 데이터 표시 (타임스탬프 포함)
- 단위 및 통화 명확성: 모든 값에 단위 및 통화 표시
- 데이터 출처 표기: 각 위젯에 데이터 출처 명시

### G. 사용자 커스터마이제이션 (선택적)
- 대시보드 뷰 저장 (로컬 스토리지 또는 사용자 계정)
- 개인화된 설정 저장

### H. 보안 및 컴플라이언스
- API 키는 서버 측에서만 관리
- 사용자 입력 검증 (외부 API 쿼리 시 인젝션 방지)
- 데이터 출처 명시 및 출처 링크 제공
- 오픈 데이터 사용 시 적절한 출처 표기

## 5. 한국은행 ECOS API 연동 상세

### API 구조 이해

1. **엔드포인트 형식**
```
/StatisticSearch/{KEY}/{언어}/{요청시작건수}/{요청종료건수}/{통계표코드}/{주기}/{시작일자}/{종료일자}/{항목코드}
```

2. **주요 파라미터**
   - `stat_code`: 통계표 코드 (예: "731Y001" - 주요국 통화의 대원화 환율, "722Y001" - 기준금리)
   - `item_code`: 항목 코드 (예: "0000001" - USD, "0101000" - 기준금리)
   - `cycle`: 주기 (D: 일, M: 월, Q: 분기, Y: 연, A: 연)
   - `start_date`, `end_date`: YYYYMMDD 형식 (주기에 따라 변환됨)

### BOK_MAPPING 구조

`server/bok_backend.py`의 `BOK_MAPPING` 딕셔너리에 카테고리와 항목을 정의:

```python
BOK_MAPPING = {
    "exchange": {
        "stat_code": "731Y001",
        "name": "환율 및 금리",
        "default_cycle": "D",
        "items": {
            "USD": {"code": "0000001", "name": "미국 달러 (USD)"},
            # ...
        },
        "default_item": "USD"
    },
    "interest": {
        "stat_code": "722Y001",
        "name": "기준금리",
        "default_cycle": "D",
        "items": {
            "BASE_RATE": {"code": "0101000", "name": "기준금리"}
        },
        "default_item": "BASE_RATE"
    }
}
```

### 새로운 카테고리/항목 추가 절차

1. **API 명세서 확인**
   - `docs/api/ecos/` 디렉토리의 개발 명세서 확인
   - 통계표 코드 및 항목 코드 확인

2. **BOK_MAPPING 업데이트**
   - `server/bok_backend.py`의 `BOK_MAPPING`에 새 카테고리 추가
   - `stat_code`, `default_cycle`, `items` 정보 포함

3. **백엔드 API 엔드포인트 확인**
   - `server/main.py`의 `/api/market/indices` 엔드포인트가 새 카테고리 지원 확인

4. **프론트엔드 Agent와 협업** (필요시)
   - UI 컴포넌트 추가는 프론트엔드 Agent와 협의

### 새로운 통화 추가 절차

1. **item_code 확인**
   - `docs/CURRENCY_MAPPING_TABLE.md`에서 해당 통화의 `item_code` 확인
   - 또는 ECOS API를 직접 테스트하여 확인

2. **BOK_MAPPING 업데이트**
   - `server/bok_backend.py`의 `BOK_MAPPING["exchange"]["items"]`에 추가

3. **프론트엔드 업데이트** (필요시)
   - `frontend/ai_studio_code_F2.html`에 통화 버튼 및 색상 추가
   - 이 작업은 프론트엔드 Agent와 협업

4. **문서 업데이트**
   - `docs/CURRENCY_MAPPING_TABLE.md` 업데이트

## 6. 에러 처리

### API 에러 응답 구조
```json
{
    "RESULT": {
        "CODE": "ERROR-001",
        "MESSAGE": "에러 메시지"
    }
}
```

### 에러 코드 처리
- `INFO-000`: 정상
- `ERROR-101`: 날짜 형식 오류 (주기와 날짜 형식 불일치)
- `INFO-200`: 해당하는 데이터가 없음
- 그 외: 에러 처리 및 로깅

### 타임아웃 처리
- API 타임아웃: 30초
- 타임아웃 발생 시 명확한 에러 메시지 반환
- 재시도 로직 고려 (선택적)

## 7. 데이터 검증

### 날짜 형식 검증
- `validate_date_format()` 함수 사용
- YYYYMMDD 형식만 허용
- 주기에 따른 날짜 형식 변환 (`format_date_for_cycle()`)

### 날짜 범위 검증
- 시작일이 종료일보다 늦을 수 없음
- 최대 조회 기간: 5년 (1825일)
- 기간에 따른 `end_index` 자동 계산

### 주기 검증
- 유효한 주기: D, M, Q, Y, A
- 주기별 날짜 형식 변환 필수

## 8. 로깅

### 로깅 레벨
- INFO: 정상 API 호출, 자동 계산된 end_index
- WARNING: Fallback API 키 사용, 데이터 부재
- ERROR: API 에러, 타임아웃, 파싱 오류

### 로깅 내용
- API 요청 파라미터 (stat_code, item_code, cycle, 날짜 범위)
- 응답 데이터 개수
- 자동 계산된 end_index 값
- 에러 메시지 및 스택 트레이스

## 9. 테스트

### API 테스트
- 새로운 카테고리/항목 추가 시 실제 API 호출 테스트
- 다양한 날짜 범위 테스트
- 주기별 (D, M, Q, A) 테스트
- 에러 케이스 테스트 (잘못된 날짜, 범위 초과 등)

### 통합 테스트
- 백엔드 → 프론트엔드 데이터 흐름 확인
- 프론트엔드 렌더링 확인
- 필터 및 인터랙션 동작 확인

### 사용자 시나리오 테스트
- 실제 사용자 워크플로우 시뮬레이션
- 다양한 화면 크기에서 테스트
- 성능 테스트 (대용량 데이터 처리)

## 10. 참고 파일

- `@docs/api/ecos/` - 한국은행 ECOS API 개발 명세서
- `@server/bok_backend.py` - API 연동 모듈
- `@server/main.py` - Flask API 엔드포인트
- `@frontend/ai_studio_code_F2.html` - 메인 프론트엔드 파일
- `@docs/CURRENCY_MAPPING_TABLE.md` - 통화 매핑 테이블

## 11. 기획 워크플로우

### 기능 기획 시 체크리스트

1. **API 분석**
   - [ ] API 명세서 확인
   - [ ] 핵심 메트릭 식별
   - [ ] 데이터 구조 이해

2. **기능 설계**
   - [ ] 유저 스토리 작성
   - [ ] 시각화 방법 결정
   - [ ] 필터 및 컨트롤 설계

3. **기술 검토**
   - [ ] API Rate Limit 확인
   - [ ] 캐싱 전략 수립
   - [ ] 에러 처리 방안

4. **UI/UX 검토**
   - [ ] 기존 디자인 시스템과의 일관성
   - [ ] 반응형 디자인 고려
   - [ ] 접근성 확인

5. **개발팀 협의**
   - [ ] 백엔드 Agent와 API 연동 방법 협의
   - [ ] 프론트엔드 Agent와 UI 구현 방법 협의
   - [ ] UI/UX Agent와 디자인 일관성 확인

---

이 규칙은 기능 기획부터 API 연동까지의 전체 프로세스를 다루며, 개발팀이 일관된 방식으로 기능을 구현할 수 있도록 가이드합니다.
